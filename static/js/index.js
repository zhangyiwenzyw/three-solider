var g=function(){"use strict";function r(t,i){this.x=t||0,this.y=i||0}Object.defineProperties(r.prototype,{width:{get:function(){return this.x},set:function(t){this.x=t}},height:{get:function(){return this.y},set:function(t){this.y=t}}}),Object.assign(r.prototype,{isVector2:!0,set:function(t,i){return this.x=t,this.y=i,this},setScalar:function(t){return this.x=t,this.y=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setComponent:function(t,i){switch(t){case 0:this.x=i;break;case 1:this.y=i;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},add:function(t,i){return void 0!==i?(console.warn("Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,i)):(this.x+=t.x,this.y+=t.y,this)},addScalar:function(t){return this.x+=t,this.y+=t,this},addVectors:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this},addScaledVector:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this},sub:function(t,i){return void 0!==i?(console.warn("Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,i)):(this.x-=t.x,this.y-=t.y,this)},subScalar:function(t){return this.x-=t,this.y-=t,this},subVectors:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this},multiply:function(t){return this.x*=t.x,this.y*=t.y,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divide:function(t){return this.x/=t.x,this.y/=t.y,this},divideScalar:function(t){return this.multiplyScalar(1/t)},applyMatrix3:function(t){var i=this.x,e=this.y,n=t.elements;return this.x=n[0]*i+n[3]*e+n[6],this.y=n[1]*i+n[4]*e+n[7],this},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this},clamp:function(t,i){return this.x=Math.max(t.x,Math.min(i.x,this.x)),this.y=Math.max(t.y,Math.min(i.y,this.y)),this},clampScalar:function(t,i){return this.x=Math.max(t,Math.min(i,this.x)),this.y=Math.max(t,Math.min(i,this.y)),this},clampLength:function(t,i){var e=this.length();return this.divideScalar(e||1).multiplyScalar(Math.max(t,Math.min(i,e)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(t){return this.x*t.x+this.y*t.y},cross:function(t){return this.x*t.y-this.y*t.x},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var i=this.x-t.x,e=this.y-t.y;return i*i+e*e},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,i){return this.x+=(t.x-this.x)*i,this.y+=(t.y-this.y)*i,this},lerpVectors:function(t,i,e){return this.subVectors(i,t).multiplyScalar(e).add(t)},equals:function(t){return t.x===this.x&&t.y===this.y},fromArray:function(t,i){return void 0===i&&(i=0),this.x=t[i],this.y=t[i+1],this},toArray:function(t,i){return void 0===t&&(t=[]),void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t},fromBufferAttribute:function(t,i,e){return void 0!==e&&console.warn("Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(i),this.y=t.getY(i),this},rotateAround:function(t,i){var e=Math.cos(i),n=Math.sin(i),s=this.x-t.x,o=this.y-t.y;return this.x=s*e-o*n+t.x,this.y=s*n+o*e+t.y,this}});var n=new r;function i(t,i){this.min=void 0!==t?t:new r(1/0,1/0),this.max=void 0!==i?i:new r(-1/0,-1/0)}Object.assign(i.prototype,{set:function(t,i){return this.min.copy(t),this.max.copy(i),this},setFromPoints:function(t){this.makeEmpty();for(var i=0,e=t.length;i<e;i++)this.expandByPoint(t[i]);return this},setFromCenterAndSize:function(t,i){var e=n.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(e),this.max.copy(t).add(e),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(t){return void 0===t&&(console.warn("THREE.Box2: .getCenter() target is now required"),t=new r),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return void 0===t&&(console.warn("THREE.Box2: .getSize() target is now required"),t=new r),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y},getParameter:function(t,i){return void 0===i&&(console.warn("THREE.Box2: .getParameter() target is now required"),i=new r),i.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)},clampPoint:function(t,i){return void 0===i&&(console.warn("THREE.Box2: .clampPoint() target is now required"),i=new r),i.copy(t).clamp(this.min,this.max)},distanceToPoint:function(t){return n.copy(t).clamp(this.min,this.max).sub(t).length()},intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(t){return this._invoke("next",t)},t.prototype.throw=function(t){return this._invoke("throw",t)},t.prototype.return=function(t){return this._invoke("return",t)};function u(t){this.value=t}function t(s){var o,a;function h(t,i){try{var e=s[t](i),n=e.value;n instanceof u?Promise.resolve(n.value).then(function(t){h("next",t)},function(t){h("throw",t)}):r(e.done?"return":"normal",e.value)}catch(t){r("throw",t)}}function r(t,i){switch(t){case"return":o.resolve({value:i,done:!0});break;case"throw":o.reject(i);break;default:o.resolve({value:i,done:!1})}(o=o.next)?h(o.key,o.arg):a=null}this._invoke=function(n,s){return new Promise(function(t,i){var e={key:n,arg:s,resolve:t,reject:i,next:null};a?a=a.next=e:(o=a=e,h(n,s))})},"function"!=typeof s.return&&(this.return=void 0)}function s(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var e=function(t,i,e){return i&&o(t.prototype,i),e&&o(t,e),t};function o(t,i){for(var e=0;e<i.length;e++){var n=i[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):t.__proto__=i)}function c(t,i){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i}var l=function(t){var i=[],e=[];t.forEach(function(t){i.push(t.x),e.push(t.y)});for(var n=i[0],s=i[0],o=e[0],a=e[0],h=1;h<i.length;h++)n<i[h]&&(n=i[h]),s=i[h]<s?i[h]:s;for(var r=1;r<e.length;r++)o<e[r]&&(o=e[r]),a=e[r]<a?e[r]:a;return{minPos:{x:s,y:a},maxPos:{x:n,y:o}}},v=(e(f,[{key:"getSelectData",value:function(){return this}},{key:"setPosition",value:function(t){this._position.x=t.x,this._position.y=t.y}},{key:"getPosition",value:function(){return this._position}},{key:"setBackgroundColor",value:function(t){this._backgroundColor=t}},{key:"getBackgroundColor",value:function(){return this._backgroundColor}},{key:"setWidth",value:function(t){this._width=t}},{key:"getWidth",value:function(){return this._width}},{key:"setHeight",value:function(t){this._height=t}},{key:"getHeight",value:function(){return this._height}},{key:"setAttr",value:function(t){this._attrObj=Object.assign({},t)}},{key:"getAttr",value:function(){return this._attrObj}},{key:"setSize",value:function(t){this._width=t.width,this._height=t.height}},{key:"getSize",value:function(){return{width:this._width,height:this._height}}},{key:"setStyle",value:function(t){for(var i in t)this["_"+i]=t[i]}},{key:"setRotation",value:function(t){this._rotation=t}},{key:"getRotation",value:function(){return this._rotation}},{key:"setShape",value:function(t){this._shape=t}},{key:"getShape",value:function(){this._shape=shape}},{key:"getId",value:function(){return this._id}},{key:"setImage",value:function(t,i,e){this._image.url=t,this._image.x=i,this._image.y=e}}]),f);function f(){s(this,f),this._width=null,this._height=null,this._position={x:null,y:null},this._backgroundColor=null,this._borderColor="#333",this._attrObj={},this._shape=null,this._edge=null,this._rotation=0,this._id=(new Date).getTime(),this._transformOriginX=.5,this._transformOriginY=.5,this._alpha=null,this._image={}}var d=(e(y,[{key:"getPosition",value:function(){return this._position}},{key:"setClosePath",value:function(t){this.isClosePath=t}},{key:"setPosition",value:function(t){for(var i=this._points.length,e=t.x-this._position.x,n=t.y-this._position.y,s=0;s<i;s++){var o=this._points[s];o.x+=e,o.y+=n}this._position.x=t.x,this._position.y=t.y}},{key:"getPoints",value:function(){return this._points}},{key:"setPoints",value:function(t){var i=this;this._points.splice(0,this._points.length),t.forEach(function(t){i._points.push(t)});var e=l(t),n=e.minPos,s=e.maxPos;this._width=s.x-n.x,this._height=s.y-n.y,this._position={},this._position.x=n.x+this._transformOriginX*this._width,this._position.y=n.y+this._transformOriginY*this._height}},{key:"setSegments",value:function(t){this._segments=t}},{key:"getSegments",value:function(){return this._segments}},{key:"getId",value:function(){return this._id}},{key:"setAttr",value:function(t){this._attrObj=Object.assign(this._attrObj,t)}},{key:"getAttr",value:function(){return this._attrObj}},{key:"setRotation",value:function(t){this._rotation=t}},{key:"getRotation",value:function(){return this._rotation}},{key:"getRoutePoints",value:function(t){for(var i=1/t,e=[],n=1;n<=t;n++){var s=n*i,o=Math.pow(1-s,2)*this._points[0].x+2*s*(1-s)*this._points[1].x+Math.pow(s,2)*this._points[2].x,a=Math.pow(1-s,2)*this._points[0].y+2*s*(1-s)*this._points[1].y+Math.pow(s,2)*this._points[2].y;e.push({x:o,y:a})}return e}}]),y);function y(){s(this,y),this._id=(new Date).getTime(),this._points=[],this._segments=[],this._rotation=0,this._borderColor="#333",this._transformOriginX=.5,this._transformOriginY=.5,this._attrObj={},this.isClosePath=!1}var m=(e(x,[{key:"getId",value:function(){return this._id}},{key:"setStyle",value:function(t){for(var i in t)this[i]=t[i]}},{key:"width",set:function(t){this._width=t},get:function(){return this._width}},{key:"height",set:function(t){this._height=t},get:function(){return this._height}},{key:"color",set:function(t){this._color=t},get:function(){return this._color}},{key:"font",set:function(t){this._font=t},get:function(){return this._font}},{key:"type",set:function(t){this._type=t},get:function(){return this._type}},{key:"text",get:function(){return this._text},set:function(t){this._text=t}},{key:"position",get:function(){return this._position},set:function(t){this._position={x:t.x,y:t.y}}}]),x);function x(){s(this,x)}var _=(e(g,[{key:"init",value:function(){if(this.visible){var t=this.hrulerCanvas=document.createElement("canvas"),i=this.vrulerCanvas=document.createElement("canvas");this.dom?(this.dom.appendChild(t),this.dom.appendChild(i),t.width=this.dom.offsetWidth-this.rulerSize,t.height=this.rulerSize,i.width=this.rulerSize,i.height=this.dom.offsetHeight-this.rulerSize,t.style.width=this.dom.offsetWidth-this.rulerSize+"px",t.style.height=this.rulerSize+"px",i.style.width=this.rulerSize+"px",i.style.height=this.dom.offsetHeight-this.rulerSize+"px"):(document.body.appendChild(editCanvas),document.body.appendChild(canvas)),this.hrulerctx=this.hrulerCanvas.getContext("2d"),this.vrulerctx=this.vrulerCanvas.getContext("2d"),t.style.position="absolute",i.style.position="absolute";var e=this.rulerSize;t.style.top=0,t.style.left=e+"px",t.style.zIndex=99,i.style.top=e+"px",i.style.left=0,i.style.zIndex=99,t.style.background="rgb(255, 255, 255)",i.style.background="rgb(255, 255, 255)"}}},{key:"drawVRuler",value:function(){var t=this.vrulerctx,i=this.mainCanvas.getCanvasInfo(),e=(i.x,i.y),n=i.width,s=i.height,o=this.mainCanvas,a=this.gridBlockSize;t.save(),t.beginPath(),t.setTransform(o._zoom,0,0,o._zoom,0,o._zoom*o.translateY),t.strokeStyle="gray";for(var h=0;h<s;h++)h%a==0&&(t.moveTo(10/o._zoom,e-e%a+h),t.lineTo(25/o._zoom+n,e-e%a+h));t.closePath(),t.stroke(),t.beginPath(),t.strokeStyle="gray",t.lineWidth=1;for(var r=a*a,u=0;u<s;u++)u%r==0&&(t.moveTo(0,e-e%r+u),t.lineTo(25/o._zoom,e-e%r+u));for(var c=0;c<s;c++)if(c%r==0){this.remainderY=Math.ceil(e/r);var l=12/o._zoom;t.font=l+"px sans-serif",t.fillText(c+this.remainderY*r,0/o._zoom,e-e%r+c)}t.closePath(),t.stroke(),t.restore()}},{key:"drawHRuler",value:function(){var t=this.hrulerctx,i=this.mainCanvas.getCanvasInfo(),e=i.x,n=(i.y,i.width),s=this.mainCanvas,o=this.gridBlockSize;t.save(),t.beginPath(),t.setTransform(s._zoom,0,0,s._zoom,s._zoom*s.translateX,0),t.strokeStyle="gray";for(var a=0;a<n;a++)a%o==0&&(t.moveTo(e-e%o+a,10/s._zoom),t.lineTo(e-e%o+a,25/s._zoom));t.closePath(),t.stroke(),t.beginPath(),t.strokeStyle="gray",t.lineWidth=1;for(var h=o*o,r=25/s._zoom,u=0;u<n;u++)if(u%h==0){this.remainderX=Math.ceil(e/h);var c=12/s._zoom;t.font=c+"px sans-serif",t.fillText(u+this.remainderX*h,e-e%h+u,10/s._zoom),t.moveTo(e-e%h+u,0),t.lineTo(e-e%h+u,r)}t.closePath(),t.stroke(),t.restore()}},{key:"clearRuler",value:function(){this.hrulerctx.clearRect(0,0,this.hrulerCanvas.width,this.hrulerCanvas.height),this.vrulerctx.clearRect(0,0,this.vrulerCanvas.width,this.vrulerCanvas.height)}}]),g);function g(t,i){s(this,g),this.rulerSize=25,this.dom=t,this.visible=!0,this.mainCanvas=i,this.gridBlockSize=10}var p="#3A85FF",k=(e(w,[{key:"open",value:function(){console.log("开启")}},{key:"close",value:function(){console.log("关闭")}},{key:"mousedownEvent",value:function(){}},{key:"mousemoveEvent",value:function(){}},{key:"mouseupEvent",value:function(){}},{key:"draw",value:function(){}}]),w);function w(t){s(this,w),this.enable=!1,this.isEnable=void 0,this._canvas=t,Object.defineProperty(this,"enable",{configurable:!0,enumerable:!0,get:function(){return _this.isEnable},set:function(t){var i=this;t?(this.open(),this._canvas.editCanvas.style.zIndex=100,this.draw(this._canvas.editctx),this.listenMouseDown=function(t){i.mousedownEvent(t)},this._canvas.editCanvas.addEventListener("mousedown",this.listenMouseDown),this.listenMouseMove=function(t){i.mousemoveEvent(t),i.draw(i._canvas.editctx)},this._canvas.editCanvas.addEventListener("mousemove",this.listenMouseMove),this.listenMouseUp=function(t){i.mouseupEvent(t),i.draw(i._canvas.editctx)},this._canvas.editCanvas.addEventListener("mouseup",this.listenMouseUp)):(this.close(),this._canvas.editCanvas.removeEventListener("mousedown",this.listenMouseDown),this._canvas.editCanvas.removeEventListener("mouseup",this.listenMouseUp),this._canvas.editCanvas.removeEventListener("mousemove",this.listenMouseMove),this._canvas.editCanvas.style.zIndex=0),this.isEnable=t}})}var b=(e(P,[{key:"addEventListener",value:function(t,i,e){var n=this.evenList[t];void 0===n&&(n=[],this.evenList[t]=n);var s={func:i,context:e};return n.push(s),s}},{key:"removeEventListener",value:function(t,i,e){var n=this.evenList[t];if(void 0!==n)for(var s=n.length,o=0;o<s;o++){var a=n[o];if(a.func===i&&a.context===e)return void n.splice(o,1)}}},{key:"dispatchEvent",value:function(t,i){var e=this.evenList[t];if(void 0!==e)for(var n=e.length,s=0;s<n;s++){var o=e[s],a=o.func,h=o.context;null!=h?a.call(h,i):a(i)}}}]),P);function P(){s(this,P),this.evenList={}}var M=(e(C,[{key:"init",value:function(){var t=this;Object.defineProperty(this.dataModel,"_datas",{configurable:!0,enumerable:!0,get:function(){return t.dataModel._dataMap},set:function(){t.painting()}}),window.document.oncontextmenu=function(){return!1},this.initEventBus(),this.addMouseEventListener(),this.ruler&&this.ruler.visible&&(this.ruler.drawHRuler(),this.ruler.drawVRuler()),this.initInteractor(),this.onResize()}},{key:"initInteractor",value:function(){new k(this._canvas)}},{key:"getCanvasInfo",value:function(){return{x:-this.translateX,y:-this.translateY,width:this.viewWidth,height:this.viewHeight}}},{key:"addToDom",value:function(t){this.dom=t;var i=this._canvas=document.createElement("canvas"),e=this.editCanvas=document.createElement("canvas");if(this.devicePixelRatio=window.devicePixelRatio||1,t){t.style.position="absolute",this.ctx=this._canvas.getContext("2d"),this.editctx=this.editCanvas.getContext("2d");var n=this.ruler?this.ruler.rulerSize:0;i.width=t.offsetWidth-n,i.height=t.offsetHeight-n,i.style.width=t.offsetWidth-n+"px",i.style.height=t.offsetHeight-n+"px",e.width=t.offsetWidth-n,e.height=t.offsetHeight-n,e.style.width=t.offsetWidth-n+"px",e.style.height=t.offsetHeight-n+"px",t.appendChild(e),t.appendChild(i),this.viewWidth=t.offsetWidth,this.viewHeight=t.offsetHeight}else this.ruler=new _(null,this),this.ruler.init(),document.body.appendChild(e),document.body.appendChild(i),this.ctx=this._canvas.getContext("2d"),this.editctx=this.editCanvas.getContext("2d"),i.width=window.innerWidth,i.height=window.innerHeight,i.style.width=window.innerWidth,i.style.height=window.innerHeight,e.width=window.innerWidth,e.height=window.innerHeight,e.style.width=window.innerWidth,e.style.height=window.innerHeight,this.viewWidth=window.innerWidth,this.viewHeight=window.innerHeight;i.style.position="absolute",e.style.position="absolute",i.style.background="rgba(255,255,155,0)",e.style.background="rgba(255,255,155,0)",this.init()}},{key:"onResize",value:function(){window.addEventListener("resize",function(){})}},{key:"addMouseEventListener",value:function(){this._canvas&&(this._canvas.addEventListener("click",this.clickEvent.bind(this)),this._canvas.addEventListener("dblclick",this.doubleClickEvent.bind(this)),this._canvas.addEventListener("mousedown",this.mousedownEvent.bind(this)),this._canvas.addEventListener("mousemove",this.mousemoveEvent.bind(this)),window.addEventListener("mouseup",this.mouseupEvent.bind(this)),this._canvas.addEventListener("mousewheel",this.mousewheelEvent.bind(this)),this._canvas.addEventListener("mouseenter",this.mouseenterEvent.bind(this)))}},{key:"editCanvasDraw",value:function(t){"function"==typeof t?t(this.editctx):"object"===(void 0===t?"undefined":a(t))&&console.log(t)}},{key:"clickEvent",value:function(e){var n=this,s=e.offsetX,o=e.offsetY;this.dataList.forEach(function(t){if(n.isPointsContainsRect(t,s,o)){var i=n.dataModel._lastData=t;n.dispatchEvent("clickData",{kind:"clickData",data:i,event:e})}})}},{key:"isPointsContainsRect",value:function(t,i,e){var n=t._position.x,s=t._position.y,o=t._rotation,a=t._width,h=t._height,r=Math.sin(o),u=Math.cos(o),c=t._transformOriginX*a,l=t._transformOriginY*h,v=this._zoom;return this.ctx.save(),this.ctx.beginPath(),this.ctx.setTransform(u*v,r*v,-r*v,u*v,(n+this.translateX)*v,(s+this.translateY)*v),this.ctx.rect(-c,-l,a,h),this.ctx.restore(),this.ctx.isPointInPath(i,e)}},{key:"doubleClickEvent",value:function(i){var e=this,n=i.offsetX,s=i.offsetY;this.dataList.forEach(function(t){e.isPointsContainsRect(t,n,s)&&e.dispatchEvent("doubleClickData",{kind:"doubleClickData",data:t,event:i})})}},{key:"mouseenterEvent",value:function(){}},{key:"addAttrProxy",value:function(t){function i(e){t[e]instanceof Object&&n.addAttrProxy(t[e]),Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get:function(){return o[e]},set:function(t){if("object"===(void 0===t?"undefined":a(t)))for(var i in t)o[i]=t[i];else o[e]=t;s.dispatchEvent("attributeChange",{kind:"attributeChange"}),s.painting()}})}var n=this,s=this,o=Object.assign({},t);for(var e in o)i(e)}},{key:"mousewheelEvent",value:function(t){this.scale(t)}},{key:"scale",value:function(t){var i=this._canvas.width,e=this._canvas.height,n=t.offsetX,s=t.offsetY;0<t.deltaY?5<this._zoom?this._zoom=5:this._zoom+=t.deltaY/1e3:this._zoom<=.01?this._zoom=.01:this._zoom+=t.deltaY/1e3,this.viewWidth=i/this._zoom,this.viewHeight=e/this._zoom,this.translateZoomX=-(n-n/this._zoom),this.translateZoomY=-(s-s/this._zoom),this.painting()}},{key:"mousedownEvent",value:function(e){var n=this;if(console.log(e.offsetX/this._zoom-this.translateX),!this.isTopRightInArc&&!this.isBottomRightInArc){this.startDrag=!0,this.curTranslateMoveX=this.translateMoveX,this.curTranslateMoveY=this.translateMoveY;var s=e.offsetX,o=e.offsetY;this.downPoint={x:s,y:o},this.dataList.forEach(function(t){if(n.isPointsContainsRect(t,s,o)){n.isClickData=!0;var i=n.dataModel._lastData=t;n._lastData=i,n.lastDataOffsetX=n.toPixelPos(e).x-n._lastData.getPosition().x,n.lastDataOffsetY=n.toPixelPos(e).y-n._lastData.getPosition().y,n.painting(),n.dispatchEvent("mouseDownData",{kind:"mouseDownData",data:i,event:e})}})}}},{key:"mousemoveEvent",value:function(e){var n=this;if(!this.isTopRightInArc){this.moveData(e);var s=e.offsetX,o=e.offsetY;this.dataList.forEach(function(t){if(n.isPointsContainsRect(t,s,o)){var i=t;n.dispatchEvent("mouseMoveData",{kind:"mouseMoveData",data:i,event:e})}}),this.startDrag&&!this.isClickData&&(this.translateMoveX=this.curTranslateMoveX+(s-this.downPoint.x)/this._zoom,this.translateMoveY=this.curTranslateMoveY+(o-this.downPoint.y)/this._zoom,this.painting())}}},{key:"mouseupEvent",value:function(e){var n=this;this.startDrag=!1,this.isClickData=!1,this.editctx.setTransform(this._zoom,0,0,this._zoom,this.translateX,this.translateY);var s=e.offsetX,o=e.offsetY;this.dataList.forEach(function(t){if(n.isPointsContainsRect(t,s,o)){var i=t;n.dispatchEvent("onMouseupData",{kind:"onMouseupData",data:i,event:e})}})}},{key:"moveData",value:function(t){this.isClickData&&(this._lastData instanceof v||this._lastData instanceof d)&&this._lastData.setPosition({x:this.toPixelPos(t).x-this.lastDataOffsetX,y:this.toPixelPos(t).y-this.lastDataOffsetY})}},{key:"toPixelPos",value:function(t){return{x:t.offsetX/this._zoom-this.translateX,y:t.offsetY/this._zoom-this.translateY}}},{key:"rendering",value:function(t){t instanceof v&&this.drawNode(t),t instanceof d&&this.drawShape(t),t instanceof m&&this.drawText(t)}},{key:"drawSelectBorder",value:function(t,i){var e=t._position.x,n=t._position.y,s=t._rotation,o=t._width,a=t._height,h=Math.sin(s),r=Math.cos(s),u=t._transformOriginX*o,c=t._transformOriginY*a,l=this._zoom;i.save(),i.beginPath(),i.setTransform(r*l,h*l,-h*l,r*l,(e+this.translateX)*l,(n+this.translateY)*l),i.strokeStyle=p,i.strokeRect(-u,-c,o+1,a+1),i.restore()}},{key:"drawXY",value:function(){var t=this.getCanvasInfo(),i=t.width,e=t.height,n=this._zoom;this.ctx.save(),this.ctx.setTransform(this._zoom,0,0,this._zoom,this.translateX*n,this.translateY*n),this.ctx.beginPath(),this.ctx.lineWidth=2,this.ctx.strokeStyle="blue",this.ctx.moveTo(0,0),this.ctx.lineTo(i,0),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.lineWidth=2,this.ctx.strokeStyle="red",this.ctx.moveTo(0,0),this.ctx.lineTo(0,e),this.ctx.stroke(),this.ctx.restore()}},{key:"drawText",value:function(t){var i=this.ctx;i.font=t.font,i.fillText(t.text,t.position.x,t.position.y)}},{key:"drawShape",value:function(t){var i=this.ctx,e=t._points,n=0,s=t._rotation,o=Math.sin(s),a=Math.cos(s),h=this._zoom,r=(t._width,t._height,t._position.x),u=t._position.y,c=t._segments;i.save(),i.beginPath(),i.setTransform(a*h,o*h,-o*h,a*h,(r+this.translateX)*h,(u+this.translateY)*h),i.strokeStyle=t._borderColor;for(var l=0;l<c.length;l++){var v=c[l];0===l&&1===v?(i.moveTo(e[n].x-r,e[n].y-u),n+=1):2===v?(i.lineTo(e[n].x-r,e[n].y-u),n+=1):3===v?(i.quadraticCurveTo(e[n].x-r,e[n].y-u,e[n+1].x-r,e[n+1].y-u),n+=2):4===v&&(i.bezierCurveTo(e[n].x-r,e[n].y-u,e[n+1].x-r,e[n+1].y-u,e[n+2].x-r,e[n+2].y-u),n+=3)}t.isClosePath&&i.closePath(),i.stroke(),i.restore()}},{key:"drawNode",value:function(t){var i=this,e=t._shape,n=t._position.x,s=t._position.y,o=t._rotation,a=Math.sin(o),h=Math.cos(o),r=this._zoom,u=t._width,c=t._height,l=t._transformOriginX*u,v=t._transformOriginY*c;this.ctx.save(),this.ctx.beginPath(),this.ctx.setTransform(h*r,a*r,-a*r,h*r,(n+this.translateX)*r,(s+this.translateY)*r),t._backgroundColor&&(this.ctx.fillStyle=t._backgroundColor),t._borderColor&&(this.ctx.strokeStyle=t._borderColor),"rect"===e?t._backgroundColor?this.ctx.fillRect(-l,-v,u,c):this.ctx.strokeRect(-l,-v,u,c):"ellipse"===e&&(this.ctx.ellipse(0,0,u/2,c/2,0,0,2*Math.PI),t._backgroundColor?this.ctx.fill():this.ctx.stroke()),this.ctx.restore();var f=void 0,d=void 0;t._image.url&&(t.image?(this.ctx.save(),this.ctx.setTransform(h*r,a*r,-a*r,h*r,this.translateX*r,this.translateY*r),f=t.image.width/u,d=t.image.height/c,this.ctx.drawImage(t.image,0,0,t.image.width,t.image.height,n-u/2,s-c/2,t.image.width/f,t.image.height/d),this.ctx.restore()):(t.image=new Image,t.image.src=t._image.url,t.image.onload=function(){i.ctx.save(),i.ctx.setTransform(h*r,a*r,-a*r,h*r,i.translateX*r,i.translateY*r),f=t.image.width/u,d=t.image.height/c,i.ctx.drawImage(t.image,0,0,t.image.width,t.image.height,n-u/2,s-c/2,t.image.width/f,t.image.height/d),i.ctx.restore()})),this.isAddData=!1}},{key:"painting",value:function(){var i=this;return new Promise(function(t){i.ctx.clearRect(0,0,i._canvas.width,i._canvas.height),i.ruler&&i.ruler.clearRuler(),i.translateX=i.translateMoveX+i.translateZoomX,i.translateY=i.translateMoveY+i.translateZoomY,i.dataList.forEach(function(t){i.rendering(t),i.addAttrProxy(t)}),i.dataList.findIndex(function(t){return t===i._lastData}),i.ruler&&i.ruler.visible&&(i.ruler.drawHRuler(),i.ruler.drawVRuler()),t()})}},{key:"drawCanvasGrid",value:function(){var t=this.ctx,i=this.getCanvasInfo(),e=i.x,n=i.y,s=i.width,o=i.height,a=this.gridBlockSize;t.save(),t.beginPath(),this.ctx.setTransform(this._zoom,0,0,this._zoom,this._zoom*this.translateX,this._zoom*this.translateY),t.lineWidth=1,t.strokeStyle="rgba(228,228,228,1)";for(var h=0;h<s;h++)h%a==0&&(t.moveTo(e-e%a+h,n),t.lineTo(e-e%a+h,n+o));for(var r=0;r<o;r++)r%a==0&&(t.moveTo(e,n-n%a+r),t.lineTo(e+s,n-n%a+r));t.closePath(),t.stroke(),t.beginPath(),t.strokeStyle="rgba(219,219,219,1)",t.lineWidth=1;for(var u=a*a,c=0;c<s;c++)c%u==0&&(t.moveTo(e-e%u+c,n),t.lineTo(e-e%u+c,n+o));for(var l=0;l<o;l++)l%u==0&&(t.moveTo(e,n-n%u+l),t.lineTo(e+s,n-n%u+l));t.closePath(),t.stroke(),t.restore()}},{key:"initEventBus",value:function(){this.eventBus=new b}},{key:"addEventListener",value:function(t,i,e){var n=this.evenList[t];void 0===n&&(n=[],this.evenList[t]=n);var s={func:i,context:e};return n.push(s),s}},{key:"removeEventListener",value:function(t,i,e){var n=this.evenList[t];if(void 0!==n)for(var s=n.length,o=0;o<s;o++){var a=n[o];if(a.func===i&&a.context===e)return void n.splice(o,1)}}},{key:"dispatchEvent",value:function(t,i){var e=this.evenList[t];if(void 0!==e)for(var n=e.length,s=0;s<n;s++){var o=e[s],a=o.func,h=o.context;null!=h?a.call(h,i):a(i)}}},{key:"eventOffsetTransform",value:function(t){return{x:t.offsetX-this.translateX,y:t.offsetY-this.translateY}}},{key:"getZoom",value:function(){return this._zoom}}]),C);function C(t){s(this,C),t&&(this.dataModel=t,this.dataList=t._dataList,this._lastData=null,this.evenList={},this._zoom=1,this.x=0,this.y=0,this.translateX=0,this.translateY=0,this.translateMoveX=0,this.translateMoveY=0,this.translateZoomX=0,this.translateZoomY=0,this.gridBlockSize=10)}var E=(e(T,[{key:"add",value:function(t){if(t instanceof v||t instanceof d||t instanceof m){var i=t.getId();this._dataMap[i]=t,this._dataList.push(t),this._datas=this._dataMap[i]}}},{key:"remove",value:function(e){function t(i){if(Number(i)===e.getId()){delete n._dataMap[i];var t=n._dataList.findIndex(function(t){return Number(i)===t._id});n._dataList.splice(t,1),n._datas=void 0}}var n=this;for(var i in this._dataMap)t(i)}},{key:"getDataContainerList",value:function(){return this._dataList}},{key:"getLastSelectData",value:function(){return this._lastData}}]),T);function T(){s(this,T),this._dataList=[],this._dataMap={},this._datas={},this._lastData=null}var S=(h(z,k),e(z,[{key:"open",value:function(){this._canvas.editCanvasDraw(this)}},{key:"close",value:function(){this.redraw(),1<this._points.length&&(this._points=[])}},{key:"mousedownEvent",value:function(t){if("rect"===this.style.type){if("0"==t.button){var i=this._canvas.eventOffsetTransform(t);this.p1={x:i.x,y:i.y},this._points.push(this.p1)}"2"==t.button&&(this.enable=!1)}}},{key:"mouseupEvent",value:function(){4===this._points.length&&(this.createRect(this._points),this._points.splice(0,this._points.length),this.redraw())}},{key:"mousemoveEvent",value:function(t){if(this._points.length){var i=this._canvas.eventOffsetTransform(t),e={x:i.x,y:i.y},n={x:e.x,y:this.p1.y},s={x:this.p1.x,y:e.y},o=this._points;1<o.length&&o.splice(1,3),o.length&&(o.push(n),o.push(e),o.push(s),this.redraw())}}},{key:"redraw",value:function(){var t=this._canvas.getCanvasInfo();this._canvas.editctx.clearRect(t.x,t.y,t.width,t.height)}},{key:"draw",value:function(t){if(this._points.length){var i=this._points.length,e=this._points;4===i&&(t.lineWidth=3,t.strokeStyle="#979797",t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.lineTo(e[2].x,e[2].y),t.lineTo(e[3].x,e[3].y),t.closePath(),t.stroke())}}}]),z);function z(t,i,e){s(this,z);var n=c(this,(z.__proto__||Object.getPrototypeOf(z)).call(this));return n._canvas=t,n._points=[],n.createRect=i,n.style=e,n}var R=(h(D,k),e(D,[{key:"open",value:function(){}},{key:"close",value:function(){if(this.redraw(),1<this._points.length){for(var t=1;t<this._points.length;t++)this._segments.push(2);this.createShape(this._points,this._segments)}this._points=[],this._segments=[1]}},{key:"mousedownEvent",value:function(t){"2"==t.button&&(this.enable=!1)}},{key:"mousemoveEvent",value:function(t){this.movePoints=this._canvas.eventOffsetTransform(t),this.redraw()}},{key:"mouseupEvent",value:function(t){if("Shape"===this.style.type){var i=this._canvas.eventOffsetTransform(t);this._points.push(i)}}},{key:"redraw",value:function(){var t=this._canvas.getCanvasInfo();this._canvas.editctx.clearRect(t.x,t.y,t.width,t.height)}},{key:"draw",value:function(t){var i=this._points.length,e=this._points;if(i&&0<i){t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var n=1;n<i;n++){var s=this._points[n];t.lineTo(s.x,s.y)}this.movePoints&&t.lineTo(this.movePoints.x,this.movePoints.y),t.stroke()}}}]),D);function D(t,i,e){s(this,D);var n=c(this,(D.__proto__||Object.getPrototypeOf(D)).call(this));return n._canvas=t,n._points=[],n._segments=[1],n.createShape=i,n.style=e,n}var O=(h(I,k),e(I,[{key:"open",value:function(){}},{key:"mousedownEvent",value:function(t){if(this._canvas._lastData){var i=this.downPos=this._canvas.eventOffsetTransform(t),e=this.isTopRightInArc=this.isTopRightPointInCircle(i),n=this.isBottomRightInArc=this.isBottomRightPointInCircle(i);this._canvas.isTopRightInArc=e,this._canvas.isBottomRightInArc=n}}},{key:"mouseupEvent",value:function(){this._canvas.isTopRightInArc=!1,this._canvas.isBottomRightInArc=!1}},{key:"mousemoveEvent",value:function(t){if(this._canvas.isTopRightInArc){var i=new r(this.topRightPoint.x,this.topRightPoint.y),e=new r(this._canvas._lastData._position.x,this._canvas._lastData._position.y),n=new r(this._canvas.eventOffsetTransform(t).x,this._canvas.eventOffsetTransform(t).y),s=e.clone().sub(i),o=e.clone().sub(n),a=s.dot(o)/(s.length()*o.length()),h=Math.acos(a);0<s.cross(o)?this._canvas._lastData.setRotation(h):this._canvas._lastData.setRotation(-h)}this._canvas.isBottomRightInArc&&(console.log("isBottomRightInArc"),this.downPos.x,this._canvas.eventOffsetTransform(t).x,this.downPos.y,this._canvas.eventOffsetTransform(t).y,this._canvas._lastData)}},{key:"isTopRightPointInCircle",value:function(t){var i=this._canvas._lastData._position,e=this._canvas._lastData._rotation,n=(this.topRightPoint.x-i.x)*Math.cos(e)-(this.topRightPoint.y-i.y)*Math.sin(e)+i.x,s=(this.topRightPoint.x-i.x)*Math.sin(e)+(this.topRightPoint.y-i.y)*Math.cos(e)+i.y,o=n-t.x,a=s-t.y;return o*o+a*a<=25}},{key:"isBottomRightPointInCircle",value:function(t){var i=this._canvas._lastData._position,e=this._canvas._lastData._rotation,n=(this.bottomRightPoint.x-i.x)*Math.cos(e)-(this.bottomRightPoint.y-i.y)*Math.sin(e)+i.x,s=(this.bottomRightPoint.x-i.x)*Math.sin(e)+(this.bottomRightPoint.y-i.y)*Math.cos(e)+i.y,o=n-t.x,a=s-t.y;return o*o+a*a<=25}},{key:"draw",value:function(t){if(this._canvas._lastData){this._canvas.painting();var i=this._canvas._lastData,e=this._canvas._zoom,n=i._rotation,s=Math.sin(n),o=i._width,a=i._height,h=Math.cos(n),r=i._transformOriginX*o,u=i._transformOriginY*a,c=i._position.x-o*i._transformOriginX,l=i._position.y-a*i._transformOriginY;this.topLeftPoint={x:c,y:l},this.topRightPoint={x:c+o,y:l},this.bottomLeftPoint={x:c,y:l+a},this.bottomRightPoint={x:c+o,y:l+a},t.beginPath(),t.save(),t.setTransform(h*e,s*e,-s*e,h*e,(i._position.x+this._canvas.translateX)*e,(i._position.y+this._canvas.translateY)*e),t.strokeStyle=p,t.arc(-r,-u,5,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(r,-u,5,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(-r,u,5,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(r,u,5,0,2*Math.PI),t.stroke(),t.restore()}}}]),I);function I(t){s(this,I);var i=c(this,(I.__proto__||Object.getPrototypeOf(I)).call(this));return i._canvas=t,i}var L=(h(Y,k),e(Y,[{key:"open",value:function(){this._points=this._canvas.dataModel.getLastSelectData().getPoints()}},{key:"close",value:function(){this.redraw()}},{key:"mousedownEvent",value:function(t){"quadraticCurve"===this.style.type&&"0"==t.button&&((this.isInArc=this.isPointInCircle(this._canvas.eventOffsetTransform(t)))||(this.enable=!1))}},{key:"mousemoveEvent",value:function(t){var i,e=this.movePoints=this._canvas.eventOffsetTransform(t);this.isInArc&&(i=[this._points[0],{x:e.x,y:e.y},this._points[2]],this.redraw(),this._canvas.dataModel.getLastSelectData().setPoints(i))}},{key:"mouseupEvent",value:function(){this.isInArc=!1}},{key:"redraw",value:function(){var t=this._canvas.getCanvasInfo();this._canvas.editctx.clearRect(t.x,t.y,t.width,t.height)}},{key:"isPointInCircle",value:function(t){var i=this._points[1].x-t.x,e=this._points[1].y-t.y;return i*i+e*e<=25}},{key:"getEditData",value:function(){var t=this._canvas.dataModel.getLastSelectData();if("curveLine"===t.getAttr().type)return t}},{key:"draw",value:function(t){var i=this.getEditData();if(i){this._canvas.getZoom();var e=i.getPoints(),n=e[0],s=e[1],o=e[2];t.beginPath(),t.lineWidth=1,t.moveTo(n.x,n.y),t.lineTo(s.x,s.y),t.lineTo(o.x,o.y),t.strokeStyle="#ccc",t.stroke(),t.beginPath(),t.arc(s.x,s.y,5,0,2*Math.PI),t.fillStyle="blue",t.fill()}}}]),Y);function Y(t,i){s(this,Y);var e=c(this,(Y.__proto__||Object.getPrototypeOf(Y)).call(this));return e._canvas=t,e._points=[],e.style=i,e}return new function t(){s(this,t),this.Canvas=M,this.Node=v,this.Shape=d,this.Text=m,this.DataContainer=E,this.EventEmitter=b,this.Interactor=k,this.RectInteractor=S,this.ShapeInteractor=R,this.SelectInteractor=O,this.QuadraticCurveInteractor=L,this.Vector2=r,this.Box2=i}}();
